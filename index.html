<style>
  @import url(https://fonts.googleapis.com/css?family=Google+Sans+Text);
  html {
    font-family: 'Google Sans Text', 'Google Sans';
    font-size: 14px;
    color-scheme: light dark;
    background: light-dark(white, black);
    color: light-dark(black, white);
  }
</style>

<script type='text/javascript' src='https://www.genspark.ai/mHN1pNiJW8DpWw3gS-0F95ygtE3KuWT2ma8qDAfTv1vSlyo_gRgKvzGVFqT5sQeJaZr32J1a2eTyKnFDpTiA8A1ihHsaPL3gQ_2bcHUCGYQrxUsZAIj5ayvSetj65zP1zJ6K-Bsmn8_NF8ceO4FpGiib0u7kABjH0pGxOSZqXSKdSB4our25vFbiJDnxIpiLXL5MlySoEDntyzeyOjBs9ALtGHoISrSF66N_V5AjljiqDNhLrTuLqivXEG7Yeq8DdZhoQL3uA6Fc_JXw-8WqiA6ttRccwh_7FHy9I7aFPz-iu53NcbFwBQs2dunXZacDcFuGRAXNn4ZoCl2kRC1qdik1UPtJNvidI3TIInmJTUa4PY8AH2qiRmtPwT4Cx1ktZ8yWkbrGPL_LCV7IoOBlCTqhrGUihid5EaWRvuF5HS2O31DMxW6E06lRWRQxLgnXU_qcFRJxLE_FV99nN1V0JbUsq7b1Spwx6jl8Sm4h_rNnCUg4Lg65sztjIywOwkOuGt3Dtj8GOOW_Ql-59Rrd8OR-qQoCEZ-wIybHrpw8GtiE9aef2GJ6IDH5lokxiI79WhaKzDRDpYyTBNBP4hL0Y_zo0A93iJmAUv3di1I8BvrculXDo2T2Hyck5EBTmUF47w7d-DihYmQu-6Sq7Kop8lzMsGCs_GrUz9AeHO0bqIx93LH9WvyJyNXgpkGZa9rE5jERTiw'></script><script type="importmap">{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.35.0",
    "jszip": "https://esm.sh/jszip@^3.10.1",
    "idb": "https://esm.sh/idb@^8.0.3"
  }
}</script>

<div id="root"></div>

<script type="module">
import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import React, { useState, useEffect, useRef, useCallback } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";
import { openDB } from 'idb';
import JSZip from 'jszip';

// ===================== TYPES =====================
const AspectRatio = {
  SQUARE: "1:1",
  LANDSCAPE: "16:9",
  PORTRAIT: "9:16",
  CLASSIC: "4:3"
};

const VoiceName = {
  KORE: "Kore",
  PUCK: "Puck",
  CHARON: "Charon",
  FENRIR: "Fenrir",
  ZEPHYR: "Zephyr"
};

const ImageModel = {
  FLASH: "model_std_flash",
  NANO_COST: "model_pro_cost",
  NANO_SPEED: "model_pro_speed"
};

const VideoModel = {
  GROK: "grok",
  VEO_FAST: "veo-3.1-fast",
  VEO_QUALITY: "veo-3.1-quality"
};

const VideoFormat = {
  LONG: "long-form",
  SHORT: "short-form"
};

const CharacterAppearance = {
  AUTO: "AUTO",
  ALWAYS: "ALWAYS",
  MINIMAL: "MINIMAL"
};

// ===================== CONSTANTS =====================
const PRICING = {
  EXCHANGE_RATE: 1450,
  IMAGE_GENERATION: 0.05,
  VIDEO_VEO_FAST: 0.15,
  VIDEO_VEO_QUALITY: 0.325,
  VIDEO_GROK_6S: 0.15,
  VIDEO_GROK_10S: 0.20,
  GEMINI_FLASH_INPUT_PER_1M: 0.15,
  GEMINI_FLASH_OUTPUT_PER_1M: 0.90,
  ANALYSIS_INITIAL: 0.005,
  ANALYSIS_IMAGE: 0.01
};

const IMAGE_MODELS = [
  { id: ImageModel.FLASH, label: 'ðŸŒ Gemini 2.5 Flash ì‚¬ìš©' },
  { id: ImageModel.NANO_COST, label: 'âš¡ Nano Banana Pro (ì´ˆê³ ì† - $0.05/ìž¥, ë™ì‹œ 50ê°œ)' }
];

const VIDEO_MODELS = [
  { id: VideoModel.GROK, label: 'Grok (ê¸°ë³¸)', description: 'ë¹ ë¥¸ ìƒì„±' },
  { id: VideoModel.VEO_FAST, label: 'Veo 3.1 Fast (720p)', description: 'Laozhang API (ê°€ì„±ë¹„)' },
  { id: VideoModel.VEO_QUALITY, label: 'Veo 3.1 Quality (1080p)', description: 'Kie.ai API (ê³ í™”ì§ˆ)' }
];

const VIDEO_FORMATS = [
  { id: VideoFormat.LONG, label: 'ë¡±í¼ (ê¸°ë³¸)', description: 'ì˜í™”ì  í˜¸í¡, ìžì—°ìŠ¤ëŸ¬ìš´ ìž¥ë©´ ì—°ê²°' },
  { id: VideoFormat.SHORT, label: 'ìˆí¼ (ë¹ ë¦„)', description: '1.5ì´ˆ ë‚˜ë…¸ íŽ˜ì´ì‹± (ì˜ë¯¸ ë‹¨ìœ„ ì¹¼ë°•/ë¹ ë¥¸ ì „í™˜)' }
];

const RATIOS = [
  { id: AspectRatio.LANDSCAPE, label: '16:9 (ê°€ë¡œí˜•/ìœ íŠœë¸Œ)' },
  { id: AspectRatio.PORTRAIT, label: '9:16 (ì„¸ë¡œí˜•/ì‡¼ì¸ )' },
  { id: AspectRatio.SQUARE, label: '1:1 (ì •ì‚¬ê°í˜•/ì¸ìŠ¤íƒ€)' }
];

const VOICES = [
  { id: VoiceName.KORE, label: 'Kore (ì—¬ì„±, ì°¨ë¶„í•¨)' },
  { id: VoiceName.PUCK, label: 'Puck (ë‚¨ì„±, ìž¥ë‚œìŠ¤ëŸ¬ì›€)' },
  { id: VoiceName.FENRIR, label: 'Fenrir (ë‚¨ì„±, ê¹Šì€ ëª©ì†Œë¦¬)' },
  { id: VoiceName.CHARON, label: 'Charon (ë‚¨ì„±, ê¶Œìœ„ì )' },
  { id: VoiceName.ZEPHYR, label: 'Zephyr (ì—¬ì„±, ë¶€ë“œëŸ¬ì›€)' }
];

const VISUAL_STYLES = [
  {
    category: 'ì˜í™” & ë“œë¼ë§ˆ (Movie & Drama) [ì‹¤ì‚¬ / LIVE ACTION]',
    items: [
      { label: 'ðŸŽ¬ ì‹œë„¤ë§ˆí‹±', prompt: 'Hyper realistic, 8k resolution, teal and orange color grading, epic scale, blockbuster movie tone, cinematic lighting, highly detailed', desc: 'ì••ë„ì ì¸ ìŠ¤ì¼€ì¼, í‹¸ & ì˜¤ë Œì§€ ìƒ‰ê°, ì›…ìž¥í•œ ë°°ê²½, ë¸”ë¡ë²„ìŠ¤í„° ì˜í™” í†¤' },
      { label: 'ðŸ”« ëŠì™€ë¥´/ë²”ì£„ ìŠ¤ë¦´ëŸ¬', prompt: 'Film noir style, high contrast, black and white, dramatic shadows, rough skin texture, cold blue tone, crime thriller vibe', desc: 'ë†’ì€ ëª…ì•” ëŒ€ë¹„, ì–´ë‘ìš´ ê·¸ë¦¼ìž, ê±°ì¹œ í”¼ë¶€ ì§ˆê°, ì°¨ê°€ìš´ ë¸”ë£¨ í†¤' },
      { label: 'âš”ï¸ ì‚¬ê·¹/ì‹œëŒ€ê·¹', prompt: 'Historical drama style, Hanbok, armor details, palace or nature background, heavy and classic tone, 8k, masterpiece', desc: 'í•œë³µ/ê°‘ì˜· ë””í…Œì¼, ê¶ê¶ì´ë‚˜ ìžì—° ë°°ê²½, ë¬´ê²Œê° ìžˆê³  ê³ ì „ì ì¸ í†¤' },
      { label: 'ðŸŽžï¸ ë¹ˆí‹°ì§€ í•„ë¦„', prompt: 'Vintage film style, A24 movie vibe, emotional film grain, noise, unique color grading, analog feel, retro aesthetic', desc: 'A24 ì˜í™” ìŠ¤íƒ€ì¼, ê°ì„±ì ì¸ í•„ë¦„ ê·¸ë ˆì¸(ë…¸ì´ì¦ˆ), ë…íŠ¹í•œ ìƒ‰ê°' },
      { label: 'ðŸŽ­ K-ë“œë¼ë§ˆ', prompt: 'K-Drama style, bright and warm lighting, soft skin correction, romantic atmosphere, Seoul city background, 8k, beauty', desc: 'í™”ì‚¬í•˜ê³  ë½€ì–€ í”¼ë¶€í†¤ ë³´ì •, ë°ê³  ë”°ëœ»í•œ ì¡°ëª…, ì„œìš¸ ë„ì‹œ ë°°ê²½' }
    ]
  },
  {
    category: 'CF & ì»¤ë¨¸ì…œ (Commercial & Ads) [ì‹¤ì‚¬ / LIVE ACTION]',
    items: [
      { label: 'ðŸ’§ K-ê´‘ê³ ', prompt: 'Korean beverage commercial style, blue sky, high saturation, clear and clean feeling, Korean city background, refreshing', desc: 'ì´ì˜¨ìŒë£Œ ìŠ¤íƒ€ì¼, íŒŒëž€ í•˜ëŠ˜, ë†’ì€ ì±„ë„, ë§‘ê³  ê¹¨ë—í•œ ëŠë‚Œ, í•œêµ­ ë„ì‹œ ë°°ê²½' },
      { label: 'ðŸ‘œ ëŸ­ì…”ë¦¬ íŒ¨ì…˜', prompt: 'Luxury fashion brand editorial, artistic pose, strong contrast, premium vibe, high fashion, vogue style', desc: 'ëª…í’ˆ ë¸Œëžœë“œ í™”ë³´, ì˜ˆìˆ ì ì´ê³  ë‚ ì¹´ë¡œìš´ í¬ì¦ˆ, ê°•ë ¬í•œ ëŒ€ë¹„, ê³ ê¸‰ë¯¸' },
      { label: 'ðŸ— í‘¸ë“œ ì•µê¸€', prompt: 'Food porn style, steaming hot, water droplets, glossy, high resolution food photography, delicious, macro shot', desc: 'ê¹€ì´ ëª¨ë½ëª¨ë½, íŠ€ëŠ” ë¬¼ë°©ìš¸, ìœ¤ê¸° íë¥´ëŠ” ê³ í•´ìƒë„ ìŒì‹ ì—°ì¶œ' },
      { label: 'ðŸ’» í…Œí¬ ë¯¸ë‹ˆë©€ë¦¬ì¦˜', prompt: 'Tech minimalism, Apple style, white or black background, product focus, extremely refined, clean, sleek', desc: 'ì• í”Œ ìŠ¤íƒ€ì¼, í™”ì´íŠ¸/ë¸”ëž™ ë°°ê²½, ì œí’ˆ ì¤‘ì‹¬, ê·¹ë„ë¡œ ì •ì œëœ ì„¸ë ¨ë¯¸' }
    ]
  },
  {
    category: 'ì• ë‹ˆë©”ì´ì…˜ & 3D (Animation & 3D)',
    items: [
      { label: 'ðŸ§¸ ë””ì¦ˆë‹ˆ/í”½ì‚¬ 3D', prompt: 'Disney Pixar 3D style, adorable character proportions, warm lighting, soft texture, 8k render, animation', desc: 'ì‚¬ëž‘ìŠ¤ëŸ¬ìš´ ìºë¦­í„° ë¹„ìœ¨, ë”°ëœ»í•œ ì¡°ëª…, ë§ëž‘ë§ëž‘í•œ ì§ˆê°' },
      { label: 'ðŸ“º 90s ë ˆíŠ¸ë¡œ ì• ë‹ˆ', prompt: '90s anime style, cel shading, 4:3 aspect ratio vibe, slight noise, Sailor Moon style, retro aesthetic, vhs glitch', desc: 'ì…€í™”(Cel) ì§ˆê°, 4:3 ë¹„ìœ¨ ëŠë‚Œ, ì•½ê°„ì˜ ë…¸ì´ì¦ˆ (ì„¸ì¼ëŸ¬ë¬¸/ì¹´ìš°ë³´ì´ë¹„ë°¥)' },
      { label: 'ðŸ™ï¸ ì‹ ì¹´ì´ ë§ˆì½”í† ', prompt: 'Makoto Shinkai style, lens flare, hyper-realistic high quality background, vibrant blue sky, emotional anime', desc: 'ë¹›ì˜ ì‚°ëž€(Lens flare), ê·¹ì‚¬ì‹¤ì ì¸ ê³ í€„ë¦¬í‹° ë°°ê²½ ì¤‘í™”' },
      { label: 'ðŸŒ¿ ì§€ë¸Œë¦¬', prompt: 'Studio Ghibli style, watercolor background, lush green nature, healing fluffy clouds, hand drawn, Miyazaki vibe', desc: 'ìˆ˜ì±„í™”í’ ë°°ê²½, ì´ˆë¡ë¹› ìžì—°, ížë§ë˜ëŠ” ë­‰ê²Œë­‰ê²Œí•œ êµ¬ë¦„' }
    ]
  },
  {
    category: 'ì›¹íˆ° & ì½”ë¯¹ (Webtoon & Comic)',
    items: [
      { label: 'ðŸ“± K-ì›¹íˆ°', prompt: 'Korean webtoon style, clean digital coloring, trendy fashion, sophisticated lines, manhwa, solo leveling style', desc: 'ê¹”ë”í•œ ë””ì§€í„¸ ì±„ìƒ‰, íŠ¸ë Œë””í•œ íŒ¨ì…˜, ì„¸ë ¨ëœ í•œêµ­ ì›¹íˆ° ìŠ¤íƒ€ì¼' },
      { label: 'ðŸ‡ºðŸ‡¸ ë¯¸êµ­ ì½”ë¯¹ìŠ¤', prompt: 'American comic book style, Marvel/DC vibe, thick ink lines, exaggerated muscles, dynamic angles, bold colors', desc: 'ë§ˆë¸”/DC, êµµì€ íŽœ í„°ì¹˜, ê³¼ìž¥ëœ ê·¼ìœ¡, ì—­ë™ì ì¸ ì•µê¸€' },
      { label: 'âœ’ï¸ í‘ë°± ì¶œíŒ ë§Œí™”', prompt: 'Black and white manga, screentones, pen pressure details, speed lines, Slam Dunk style, high contrast', desc: 'ìŠ¤í¬ë¦°í†¤, íŽœ ì´‰ì˜ ê°•ì•½, ì§‘ì¤‘ì„  íš¨ê³¼ (ìŠ¬ëž¨ë©í¬/ë² ë¥´ì„¸ë¥´í¬)' }
    ]
  }
];

// ===================== API SERVICE =====================
const API_STORAGE_KEY = 'all-in-one-api-settings';

const getApiSettings = () => {
  try {
    const stored = localStorage.getItem(API_STORAGE_KEY);
    return stored ? JSON.parse(stored) : {};
  } catch (e) {
    return {};
  }
};

const saveApiSettings = (settings) => {
  localStorage.setItem(API_STORAGE_KEY, JSON.stringify(settings));
};

const getKieKey = () => getApiSettings().kieKey || '';
const getLaozhangKey = () => getApiSettings().laozhangKey || '';
const getGeminiKey = () => getApiSettings().geminiKey || '';
const getCloudinaryConfig = () => ({
  cloudName: getApiSettings().cloudinaryCloudName || '',
  uploadPreset: getApiSettings().cloudinaryUploadPreset || ''
});

// ===================== LOGGER SERVICE =====================
const logger = {
  logs: [],
  listeners: [],
  
  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  },
  
  notify() {
    this.listeners.forEach(l => l([...this.logs]));
  },
  
  add(type, message, details) {
    const entry = {
      id: Date.now() + Math.random(),
      timestamp: new Date().toLocaleTimeString(),
      type,
      message,
      details
    };
    this.logs.push(entry);
    if (this.logs.length > 100) this.logs.shift();
    this.notify();
    console.log(`[${type.toUpperCase()}] ${message}`, details || '');
  },
  
  info(msg, details) { this.add('info', msg, details); },
  success(msg, details) { this.add('success', msg, details); },
  warn(msg, details) { this.add('warn', msg, details); },
  error(msg, details) { this.add('error', msg, details); },
  api(msg, details) { this.add('api', msg, details); },
  clear() { this.logs = []; this.notify(); }
};

// ===================== STORAGE SERVICE =====================
const DB_NAME = 'ai-storyboard-v2';
const STORE_NAME = 'projects';
const MAX_PROJECTS = 10;

const dbPromise = openDB(DB_NAME, 1, {
  upgrade(db) {
    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
  }
});

const saveProject = async (project) => {
  const db = await dbPromise;
  project.lastModified = Date.now();
  await db.put(STORE_NAME, project);
  console.log(`Project [${project.title}] auto-saved.`);
};

const getAllProjects = async () => {
  const db = await dbPromise;
  const projects = await db.getAll(STORE_NAME);
  return projects.sort((a, b) => b.lastModified - a.lastModified);
};

const getProject = async (id) => {
  const db = await dbPromise;
  return await db.get(STORE_NAME, id);
};

const deleteProject = async (id) => {
  const db = await dbPromise;
  await db.delete(STORE_NAME, id);
};

const deleteAllProjects = async () => {
  const db = await dbPromise;
  await db.clear(STORE_NAME);
  console.log("All projects cleared from DB.");
};

const canCreateNewProject = async () => {
  const db = await dbPromise;
  const count = await db.count(STORE_NAME);
  return count < MAX_PROJECTS;
};

// ===================== UPLOAD SERVICE =====================
const uploadMediaToHosting = async (file) => {
  const { cloudName, uploadPreset } = getCloudinaryConfig();
  if (!cloudName || !uploadPreset) {
    throw new Error("Cloudinary ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
  
  logger.info(`Cloudinary Upload Start: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', uploadPreset);
  
  const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`, {
    method: 'POST',
    body: formData
  });
  
  if (!response.ok) {
    const errData = await response.json();
    throw new Error(errData.error?.message || `Cloudinary Upload Error: ${response.statusText}`);
  }
  
  const data = await response.json();
  logger.success(`Cloudinary Upload Success: ${data.secure_url}`);
  return data.secure_url;
};

const uploadRemoteUrlToCloudinary = async (remoteUrl) => {
  const { cloudName, uploadPreset } = getCloudinaryConfig();
  if (!cloudName || !uploadPreset) {
    throw new Error("Cloudinary ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
  }
  
  logger.info(`Starting Proxy Upload for: ${remoteUrl}`);
  const formData = new FormData();
  formData.append('file', remoteUrl);
  formData.append('upload_preset', uploadPreset);
  
  const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`, {
    method: 'POST',
    body: formData
  });
  
  if (!response.ok) {
    throw new Error("Cloudinary proxy upload failed");
  }
  
  const data = await response.json();
  logger.success(`Proxy Upload Success: ${data.secure_url}`);
  return data.secure_url;
};

// ===================== GEMINI SERVICE =====================
const KIE_CHAT_URL = "https://api.kie.ai/gemini-3-pro/v1/chat/completions";
const KIE_FLASH_URL = "https://api.kie.ai/gemini-3-flash/v1/chat/completions";

const base64ToFile = (base64, filename) => {
  try {
    const arr = base64.split(',');
    const mime = arr[0].match(/:(.*?);/)?.[1] || 'image/png';
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new File([u8arr], filename, { type: mime });
  } catch (e) {
    console.error("Base64 conversion failed", e);
    return new File([], filename);
  }
};

const callKieAI = async (messages, jsonMode = false, temperature = 0.7) => {
  const apiKey = getKieKey();
  if (!apiKey) throw new Error("Kie API Key is missing. Please check API Settings.");
  
  const payload = {
    messages: messages,
    temperature: temperature,
    max_tokens: 4000,
    stream: false
  };
  
  if (jsonMode) {
    payload.response_format = { type: "json_object" };
  }
  
  const response = await fetch(KIE_CHAT_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify(payload)
  });
  
  if (!response.ok) {
    const errData = await response.json();
    throw new Error(`Kie AI API Error: ${errData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  return data.choices[0]?.message?.content || '';
};

const callFlashAI = async (messages, jsonMode = false, temperature = 0.7) => {
  const apiKey = getKieKey();
  if (!apiKey) throw new Error("Kie API Key is missing.");
  
  const payload = {
    messages: messages,
    temperature: temperature,
    max_tokens: 8000,
    stream: false
  };
  
  if (jsonMode) {
    payload.response_format = { type: "json_object" };
  }
  
  const response = await fetch(KIE_FLASH_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify(payload)
  });
  
  if (!response.ok) {
    const errData = await response.json();
    throw new Error(`Flash AI API Error: ${errData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  return data.choices[0]?.message?.content || '';
};

// Generate Laozhang Image (Nano Banana Pro)
const generateLaozhangImage = async (prompt, aspectRatio = "16:9") => {
  const apiKey = getLaozhangKey();
  if (!apiKey) throw new Error("Laozhang API Key is missing.");
  
  logger.api(`Laozhang Image Generation: ${prompt.substring(0, 50)}...`);
  
  const response = await fetch("https://api.laozhang.ai/v1/images/generations", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: "nano-banana-pro",
      prompt: prompt,
      n: 1,
      aspect_ratio: aspectRatio,
      response_format: "url"
    })
  });
  
  if (!response.ok) {
    const errData = await response.json();
    throw new Error(`Laozhang Image Error: ${errData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  const imageUrl = data.data?.[0]?.url;
  
  if (!imageUrl) throw new Error("No image URL returned from Laozhang API");
  
  logger.success(`Laozhang Image Success`);
  return imageUrl;
};

// Scene Analysis
const parseScriptToScenes = async (script, format, charAppearance = CharacterAppearance.AUTO) => {
  logger.info("Starting script analysis...");
  
  const systemPrompt = `You are a professional storyboard director. Analyze the script and split it into scenes.
For SHORT-FORM videos: Split by sentence (., ?, !)
For LONG-FORM videos: Split by paragraph/context

Return JSON array with scenes:
{
  "scenes": [
    {
      "id": "unique_id",
      "script": "scene text",
      "visualPrompt": "detailed visual description in English for AI image generation",
      "sceneType": "PRESENTER" or "SIMULATION",
      "duration": estimated_seconds
    }
  ]
}`;

  const userPrompt = `Video Format: ${format === VideoFormat.SHORT ? 'SHORT-FORM (ë¹ ë¥¸ í˜¸í¡)' : 'LONG-FORM (ì˜í™”ì )'}
Character Appearance: ${charAppearance}

Script:
${script}

Please analyze and return the scene breakdown as JSON.`;

  const result = await callFlashAI([
    { role: "system", content: systemPrompt },
    { role: "user", content: userPrompt }
  ], true, 0.3);
  
  const parsed = JSON.parse(result);
  logger.success(`Script analyzed: ${parsed.scenes?.length || 0} scenes`);
  return parsed.scenes || [];
};

// Generate image with Gemini
const generateSceneImage = async (prompt, aspectRatio = AspectRatio.LANDSCAPE, model = ImageModel.FLASH, characterBase64 = null, characterDescription = '', styleDescription = '') => {
  logger.info(`Generating image: ${prompt.substring(0, 50)}...`);
  
  let fullPrompt = prompt;
  if (styleDescription) {
    fullPrompt = `${styleDescription}. ${prompt}`;
  }
  if (characterDescription) {
    fullPrompt = `${characterDescription}. ${fullPrompt}`;
  }
  
  if (model === ImageModel.NANO_COST || model === ImageModel.NANO_SPEED) {
    // Use Laozhang Nano Banana Pro
    const arMap = {
      [AspectRatio.LANDSCAPE]: "16:9",
      [AspectRatio.PORTRAIT]: "9:16",
      [AspectRatio.SQUARE]: "1:1"
    };
    const imageUrl = await generateLaozhangImage(fullPrompt, arMap[aspectRatio] || "16:9");
    return { imageUrl, base64: null };
  }
  
  // Use Gemini Flash for image generation
  const geminiKey = getGeminiKey();
  if (!geminiKey) throw new Error("Gemini API Key is missing.");
  
  const ai = new GoogleGenAI({ apiKey: geminiKey });
  
  const contents = [];
  if (characterBase64) {
    contents.push({
      role: "user",
      parts: [
        { text: `Reference character image for consistency:` },
        { inlineData: { mimeType: "image/png", data: characterBase64.split(',')[1] } },
        { text: `Generate an image with this prompt: ${fullPrompt}. Maintain the character's appearance from the reference.` }
      ]
    });
  } else {
    contents.push({
      role: "user",
      parts: [{ text: `Generate a high-quality image for this scene: ${fullPrompt}` }]
    });
  }
  
  const response = await ai.models.generateContent({
    model: "gemini-2.0-flash-exp",
    contents,
    config: {
      responseModalities: ["image", "text"]
    }
  });
  
  const imagePart = response.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
  if (!imagePart) throw new Error("No image generated from Gemini");
  
  const base64 = `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`;
  
  // Upload to Cloudinary for persistent URL
  const file = base64ToFile(base64, 'scene_image.png');
  const imageUrl = await uploadMediaToHosting(file);
  
  logger.success("Image generated successfully");
  return { imageUrl, base64 };
};

// Analyze uploaded image
const analyzeVideoContent = async (imageBase64, imageUrl) => {
  logger.info("Analyzing uploaded image...");
  
  const messages = [
    {
      role: "user",
      content: [
        {
          type: "text",
          text: `Analyze this image and provide:
1. Detected art style (e.g., anime, realistic, 3D, etc.)
2. Character description if present (appearance, clothing, expression)
3. Scene description

Return as JSON:
{
  "artStyle": "style description",
  "characterDescription": "character details or null",
  "sceneDescription": "what's happening in the image"
}`
        },
        {
          type: "image_url",
          image_url: { url: imageUrl || imageBase64 }
        }
      ]
    }
  ];
  
  const result = await callKieAI(messages, true, 0.3);
  const parsed = JSON.parse(result);
  logger.success("Image analysis complete");
  return parsed;
};

// ===================== VIDEO GENERATION SERVICE =====================
const GROK_API_URL = "https://api.kie.ai/grok/v1/video/generations";
const LAOZHANG_VIDEO_URL = "https://api.laozhang.ai/v1/video/generations";

const generateGrokVideo = async (prompt, imageUrl, duration = "6s", audioSpeech = null) => {
  const apiKey = getKieKey();
  if (!apiKey) throw new Error("Kie API Key is missing for Grok video.");
  
  logger.api(`Grok Video Generation: ${prompt.substring(0, 50)}...`);
  
  const body = {
    model: "grok-2-image-to-video-1080p",
    prompt: prompt,
    image_url: imageUrl,
    duration: duration
  };
  
  if (audioSpeech) {
    body.audio = { speech: audioSpeech };
  }
  
  const response = await fetch(GROK_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify(body)
  });
  
  if (!response.ok) {
    const errData = await response.json();
    throw new Error(`Grok Video Error: ${errData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  const videoUrl = data.data?.[0]?.url;
  
  if (!videoUrl) throw new Error("No video URL returned from Grok API");
  
  logger.success("Grok video generated");
  return videoUrl;
};

const generateVeoVideo = async (prompt, imageUrl, quality = "fast") => {
  const apiKey = quality === "fast" ? getLaozhangKey() : getKieKey();
  const url = quality === "fast" ? LAOZHANG_VIDEO_URL : "https://api.kie.ai/veo/v1/video/generations";
  
  if (!apiKey) throw new Error(`API Key is missing for Veo ${quality} video.`);
  
  logger.api(`Veo ${quality} Video Generation: ${prompt.substring(0, 50)}...`);
  
  const model = quality === "fast" ? "veo-3.1-fast" : "veo-3.1-quality";
  
  const response = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: model,
      prompt: prompt,
      image_url: imageUrl
    })
  });
  
  if (!response.ok) {
    const errData = await response.json();
    throw new Error(`Veo Video Error: ${errData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  const videoUrl = data.data?.[0]?.url;
  
  if (!videoUrl) throw new Error("No video URL returned from Veo API");
  
  logger.success(`Veo ${quality} video generated`);
  return videoUrl;
};

// ===================== API KEY SETTINGS COMPONENT =====================
const ApiKeySettings = ({ isOpen, onClose }) => {
  const [settings, setSettings] = useState(getApiSettings());
  const [showKeys, setShowKeys] = useState({});
  
  useEffect(() => {
    if (isOpen) {
      setSettings(getApiSettings());
    }
  }, [isOpen]);
  
  const handleSave = () => {
    saveApiSettings(settings);
    alert('API ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    onClose();
    window.location.reload();
  };
  
  if (!isOpen) return null;
  
  return _jsx("div", {
    className: "fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",
    children: _jsxs("div", {
      className: "bg-gray-900 rounded-xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto",
      children: [
        _jsxs("div", {
          className: "flex justify-between items-center mb-6",
          children: [
            _jsx("h2", { className: "text-xl font-bold text-white", children: "âš™ï¸ API ì„¤ì •" }),
            _jsx("button", {
              onClick: onClose,
              className: "text-gray-400 hover:text-white text-2xl",
              children: "Ã—"
            })
          ]
        }),
        
        _jsxs("div", {
          className: "space-y-4",
          children: [
            // Kie API Key
            _jsxs("div", {
              children: [
                _jsx("label", { className: "block text-sm font-medium text-gray-300 mb-1", children: "Kie API Key (Gemini 3 Pro, Grok, Veo 1080p)" }),
                _jsx("input", {
                  type: showKeys.kie ? "text" : "password",
                  value: settings.kieKey || '',
                  onChange: (e) => setSettings({ ...settings, kieKey: e.target.value }),
                  className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                  placeholder: "sk-..."
                })
              ]
            }),
            
            // Laozhang API Key
            _jsxs("div", {
              children: [
                _jsx("label", { className: "block text-sm font-medium text-gray-300 mb-1", children: "Laozhang API Key (Nano Banana, Veo 720p)" }),
                _jsx("input", {
                  type: showKeys.laozhang ? "text" : "password",
                  value: settings.laozhangKey || '',
                  onChange: (e) => setSettings({ ...settings, laozhangKey: e.target.value }),
                  className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                  placeholder: "sk-..."
                })
              ]
            }),
            
            // Gemini API Key
            _jsxs("div", {
              children: [
                _jsx("label", { className: "block text-sm font-medium text-gray-300 mb-1", children: "Gemini API Key (í´ë°±/ë¹„ìƒìš©)" }),
                _jsx("input", {
                  type: showKeys.gemini ? "text" : "password",
                  value: settings.geminiKey || '',
                  onChange: (e) => setSettings({ ...settings, geminiKey: e.target.value }),
                  className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                  placeholder: "AIza..."
                })
              ]
            }),
            
            // Cloudinary
            _jsxs("div", {
              children: [
                _jsx("label", { className: "block text-sm font-medium text-gray-300 mb-1", children: "Cloudinary Cloud Name" }),
                _jsx("input", {
                  type: "text",
                  value: settings.cloudinaryCloudName || '',
                  onChange: (e) => setSettings({ ...settings, cloudinaryCloudName: e.target.value }),
                  className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                  placeholder: "your-cloud-name"
                })
              ]
            }),
            
            _jsxs("div", {
              children: [
                _jsx("label", { className: "block text-sm font-medium text-gray-300 mb-1", children: "Cloudinary Upload Preset" }),
                _jsx("input", {
                  type: "text",
                  value: settings.cloudinaryUploadPreset || '',
                  onChange: (e) => setSettings({ ...settings, cloudinaryUploadPreset: e.target.value }),
                  className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                  placeholder: "unsigned-preset"
                })
              ]
            })
          ]
        }),
        
        _jsxs("div", {
          className: "flex gap-3 mt-6",
          children: [
            _jsx("button", {
              onClick: onClose,
              className: "flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600",
              children: "ì·¨ì†Œ"
            }),
            _jsx("button", {
              onClick: handleSave,
              className: "flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500",
              children: "ì €ìž¥"
            })
          ]
        })
      ]
    })
  });
};

// ===================== MAIN APP COMPONENT =====================
const App = () => {
  // State
  const [scenes, setScenes] = useState([]);
  const [script, setScript] = useState('');
  const [aspectRatio, setAspectRatio] = useState(AspectRatio.LANDSCAPE);
  const [videoFormat, setVideoFormat] = useState(VideoFormat.LONG);
  const [imageModel, setImageModel] = useState(ImageModel.NANO_COST);
  const [videoModel, setVideoModel] = useState(VideoModel.GROK);
  const [voiceName, setVoiceName] = useState(VoiceName.KORE);
  const [characterAppearance, setCharacterAppearance] = useState(CharacterAppearance.AUTO);
  const [styleDescription, setStyleDescription] = useState('');
  const [customStyle, setCustomStyle] = useState('');
  
  const [characterImage, setCharacterImage] = useState(null);
  const [characterBase64, setCharacterBase64] = useState(null);
  const [characterDescription, setCharacterDescription] = useState('');
  const [characterPublicUrl, setCharacterPublicUrl] = useState(null);
  
  const [isLoading, setIsLoading] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [totalCost, setTotalCost] = useState(0);
  
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [currentProject, setCurrentProject] = useState(null);
  
  const [missingKeys, setMissingKeys] = useState([]);
  
  const fileInputRef = useRef(null);
  
  // Check API keys
  useEffect(() => {
    const missing = [];
    if (!getKieKey()) missing.push("Kie API Key (Gemini 3 Pro, Grok, Veo 1080p)");
    if (!getLaozhangKey()) missing.push("Laozhang API Key (Nano Banana, Veo 720p)");
    if (!getGeminiKey()) missing.push("Gemini API Key (í´ë°±/ë¹„ìƒìš©)");
    const cloudConfig = getCloudinaryConfig();
    if (!cloudConfig.cloudName || !cloudConfig.uploadPreset) missing.push("Cloudinary (ì´ë¯¸ì§€/ì˜ìƒ ì „ì†¡ìš©)");
    setMissingKeys(missing);
  }, []);
  
  // Estimate cost
  const estimatedSceneCount = script.split(/[.!?ã€‚]/g).filter(s => s.trim()).length;
  const estimatedCost = (estimatedSceneCount * PRICING.IMAGE_GENERATION + PRICING.ANALYSIS_INITIAL).toFixed(3);
  
  // Handle character image upload
  const handleCharacterUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    setIsAnalyzing(true);
    
    try {
      // Convert to base64
      const reader = new FileReader();
      reader.onload = async (event) => {
        const base64 = event.target.result;
        setCharacterBase64(base64);
        setCharacterImage(file);
        
        // Upload to Cloudinary
        const publicUrl = await uploadMediaToHosting(file);
        setCharacterPublicUrl(publicUrl);
        
        // Analyze image
        const analysis = await analyzeVideoContent(base64, publicUrl);
        setCharacterDescription(analysis.characterDescription || '');
        if (analysis.artStyle) {
          setStyleDescription(analysis.artStyle);
        }
        
        setIsAnalyzing(false);
      };
      reader.readAsDataURL(file);
    } catch (error) {
      console.error("Character upload error:", error);
      setIsAnalyzing(false);
      alert("ìºë¦­í„° ì´ë¯¸ì§€ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  };
  
  // Analyze script and create scenes
  const handleAnalyzeScript = async () => {
    if (!script.trim()) {
      alert("ëŒ€ë³¸ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }
    
    setIsLoading(true);
    
    try {
      const parsedScenes = await parseScriptToScenes(script, videoFormat, characterAppearance);
      
      // Add UI-specific properties
      const scenesWithUI = parsedScenes.map((scene, index) => ({
        ...scene,
        id: scene.id || `scene_${Date.now()}_${index}`,
        imageUrl: null,
        videoUrl: null,
        isGenerating: false,
        isGeneratingVideo: false
      }));
      
      setScenes(scenesWithUI);
      setTotalCost(prev => prev + PRICING.ANALYSIS_INITIAL);
    } catch (error) {
      console.error("Script analysis error:", error);
      alert("ëŒ€ë³¸ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
    
    setIsLoading(false);
  };
  
  // Generate image for a scene
  const handleGenerateImage = async (sceneId, customPrompt = null) => {
    const sceneIndex = scenes.findIndex(s => s.id === sceneId);
    if (sceneIndex === -1) return;
    
    const scene = scenes[sceneIndex];
    
    setScenes(prev => prev.map(s => 
      s.id === sceneId ? { ...s, isGenerating: true } : s
    ));
    
    try {
      const fullStyle = customStyle || styleDescription;
      const prompt = customPrompt || scene.visualPrompt;
      
      const result = await generateSceneImage(
        prompt,
        aspectRatio,
        imageModel,
        characterBase64,
        characterDescription,
        fullStyle
      );
      
      setScenes(prev => prev.map(s => 
        s.id === sceneId ? { ...s, imageUrl: result.imageUrl, isGenerating: false } : s
      ));
      
      setTotalCost(prev => prev + PRICING.IMAGE_GENERATION);
    } catch (error) {
      console.error("Image generation error:", error);
      setScenes(prev => prev.map(s => 
        s.id === sceneId ? { ...s, isGenerating: false } : s
      ));
      alert("ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  };
  
  // Generate all images
  const handleGenerateAllImages = async () => {
    if (scenes.length === 0) {
      alert("ë¨¼ì € ëŒ€ë³¸ì„ ë¶„ì„í•´ì£¼ì„¸ìš”!");
      return;
    }
    
    setIsLoading(true);
    
    for (const scene of scenes) {
      if (!scene.imageUrl) {
        await handleGenerateImage(scene.id);
      }
    }
    
    setIsLoading(false);
  };
  
  // Generate video for a scene
  const handleGenerateVideo = async (sceneId, model = videoModel) => {
    const scene = scenes.find(s => s.id === sceneId);
    if (!scene || !scene.imageUrl) {
      alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”!");
      return;
    }
    
    setScenes(prev => prev.map(s => 
      s.id === sceneId ? { ...s, isGeneratingVideo: true } : s
    ));
    
    try {
      let videoUrl;
      
      if (model === VideoModel.GROK) {
        videoUrl = await generateGrokVideo(
          scene.visualPrompt,
          scene.imageUrl,
          "6s",
          scene.script // Use script as audio speech
        );
        setTotalCost(prev => prev + PRICING.VIDEO_GROK_6S);
      } else if (model === VideoModel.VEO_FAST) {
        videoUrl = await generateVeoVideo(scene.visualPrompt, scene.imageUrl, "fast");
        setTotalCost(prev => prev + PRICING.VIDEO_VEO_FAST);
      } else {
        videoUrl = await generateVeoVideo(scene.visualPrompt, scene.imageUrl, "quality");
        setTotalCost(prev => prev + PRICING.VIDEO_VEO_QUALITY);
      }
      
      setScenes(prev => prev.map(s => 
        s.id === sceneId ? { ...s, videoUrl, isGeneratingVideo: false } : s
      ));
    } catch (error) {
      console.error("Video generation error:", error);
      setScenes(prev => prev.map(s => 
        s.id === sceneId ? { ...s, isGeneratingVideo: false } : s
      ));
      alert("ë¹„ë””ì˜¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  };
  
  // Download all assets as ZIP
  const handleDownloadZip = async () => {
    if (scenes.length === 0) return;
    
    const zip = new JSZip();
    
    for (let i = 0; i < scenes.length; i++) {
      const scene = scenes[i];
      const num = String(i + 1).padStart(2, '0');
      
      // Add script
      zip.file(`${num}_script.txt`, scene.script);
      
      // Add image if exists
      if (scene.imageUrl) {
        try {
          const response = await fetch(scene.imageUrl);
          const blob = await response.blob();
          zip.file(`${num}_image.png`, blob);
        } catch (e) {
          console.error("Failed to fetch image:", e);
        }
      }
      
      // Add video if exists
      if (scene.videoUrl) {
        try {
          const response = await fetch(scene.videoUrl);
          const blob = await response.blob();
          zip.file(`${num}_video.mp4`, blob);
        } catch (e) {
          console.error("Failed to fetch video:", e);
        }
      }
    }
    
    const content = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(content);
    const a = document.createElement('a');
    a.href = url;
    a.download = `storyboard_${Date.now()}.zip`;
    a.click();
    URL.revokeObjectURL(url);
  };
  
  // Select visual style
  const handleStyleSelect = (styleItem) => {
    setCustomStyle(styleItem.prompt);
    setStyleDescription(styleItem.label);
  };
  
  // Render
  return _jsxs("div", {
    className: "min-h-screen bg-gray-950 text-white",
    children: [
      // API Settings Modal
      _jsx(ApiKeySettings, { isOpen: isSettingsOpen, onClose: () => setIsSettingsOpen(false) }),
      
      // Header
      _jsx("header", {
        className: "bg-gray-900 border-b border-gray-800 p-4",
        children: _jsxs("div", {
          className: "max-w-7xl mx-auto flex justify-between items-center",
          children: [
            _jsx("h1", { className: "text-2xl font-bold", children: "ðŸŽ¬ ì˜¬ì¸ì› í”„ë¡œë•ì…˜" }),
            _jsxs("div", {
              className: "flex gap-3",
              children: [
                _jsx("button", {
                  onClick: () => setIsSettingsOpen(true),
                  className: "px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600",
                  children: "âš™ï¸ API ì„¤ì •"
                }),
                totalCost > 0 && _jsx("div", {
                  className: "px-4 py-2 bg-green-900/50 border border-green-700 rounded-lg",
                  children: `ðŸ’µ $${totalCost.toFixed(3)}`
                })
              ]
            })
          ]
        })
      }),
      
      // Missing Keys Warning
      missingKeys.length > 0 && _jsxs("div", {
        className: "bg-red-900/50 border-b border-red-700 p-4",
        children: [
          _jsx("h3", { className: "text-red-400 font-bold mb-2", children: "ðŸš¨ í•„ìˆ˜ API ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!" }),
          _jsx("ul", {
            className: "list-disc list-inside text-red-300",
            children: missingKeys.map((key, i) => _jsx("li", { children: key }, i))
          }),
          _jsx("p", { className: "text-red-300 mt-2", children: "â†—ï¸ ìš°ì¸¡ ìƒë‹¨ [âš™ï¸ API ì„¤ì •] í´ë¦­í•˜ì—¬ ì„¤ì •í•´ì£¼ì„¸ìš”." })
        ]
      }),
      
      // Main Content
      _jsxs("main", {
        className: "max-w-7xl mx-auto p-4",
        children: [
          // Input Section
          _jsxs("section", {
            className: "bg-gray-900 rounded-xl p-6 mb-6",
            children: [
              _jsx("h2", { className: "text-xl font-bold mb-4", children: "ðŸ“ ìƒˆ í”„ë¡œì íŠ¸ ì‹œìž‘" }),
              
              // Character Upload
              _jsxs("div", {
                className: "mb-6",
                children: [
                  _jsx("h3", { className: "text-lg font-medium mb-2", children: "1. ì°¸ì¡° ìºë¦­í„° (ì„ íƒ)" }),
                  _jsx("p", { className: "text-gray-400 text-sm mb-3", children: "ìºë¦­í„° ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ ëª¨ë“  ìž¥ë©´ì— ì¼ê´€ëœ ìºë¦­í„°ê°€ ì ìš©ë©ë‹ˆë‹¤." }),
                  _jsxs("div", {
                    className: "flex gap-4 items-start",
                    children: [
                      _jsxs("div", {
                        className: "w-32 h-32 bg-gray-800 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center cursor-pointer hover:border-blue-500 relative overflow-hidden",
                        onClick: () => fileInputRef.current?.click(),
                        children: [
                          characterBase64 ? 
                            _jsx("img", { src: characterBase64, alt: "Character", className: "w-full h-full object-cover" }) :
                            _jsx("span", { className: "text-gray-500 text-3xl", children: "ðŸ“·" }),
                          _jsx("input", {
                            ref: fileInputRef,
                            type: "file",
                            accept: "image/*",
                            onChange: handleCharacterUpload,
                            className: "hidden"
                          })
                        ]
                      }),
                      characterDescription && _jsxs("div", {
                        className: "flex-1 bg-gray-800 rounded-lg p-3",
                        children: [
                          _jsx("h4", { className: "text-sm font-medium text-gray-300 mb-1", children: "âœ¨ AI ë¶„ì„ ê²°ê³¼" }),
                          _jsx("p", { className: "text-sm text-gray-400", children: characterDescription })
                        ]
                      }),
                      isAnalyzing && _jsx("div", {
                        className: "text-blue-400",
                        children: "ë¶„ì„ ì¤‘..."
                      })
                    ]
                  })
                ]
              }),
              
              // Script Input
              _jsxs("div", {
                className: "mb-6",
                children: [
                  _jsxs("h3", { className: "text-lg font-medium mb-2", children: [
                    "2. ëŒ€ë³¸ (Script) ",
                    _jsx("span", { className: "text-red-500", children: "* í•„ìˆ˜" })
                  ]}),
                  _jsx("p", { className: "text-gray-400 text-sm mb-3", children: `ðŸŽžï¸ ì˜ˆìƒ ${estimatedSceneCount}ì»· | ì˜ˆìƒë¹„ìš©: ~$${estimatedCost}` }),
                  _jsx("textarea", {
                    value: script,
                    onChange: (e) => setScript(e.target.value),
                    placeholder: "ì˜ìƒ ëŒ€ë³¸ì„ ìž…ë ¥í•˜ì„¸ìš”...\n\nì˜ˆì‹œ:\nì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ì€ AI ì˜ìƒ ì œìž‘ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.\në¨¼ì € ëŒ€ë³¸ì„ ìž‘ì„±í•˜ê³ , AIê°€ ê° ìž¥ë©´ì˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\nê·¸ ë‹¤ìŒ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ìƒì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.",
                    className: "w-full h-48 px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white resize-none",
                    disabled: isLoading
                  })
                ]
              }),
              
              // Visual Style Selection
              _jsxs("div", {
                className: "mb-6",
                children: [
                  _jsx("h3", { className: "text-lg font-medium mb-2", children: "3. ë¹„ì£¼ì–¼ ìŠ¤íƒ€ì¼ (ì„ íƒ)" }),
                  customStyle && _jsxs("div", {
                    className: "bg-blue-900/30 border border-blue-700 rounded-lg p-3 mb-3 flex justify-between items-center",
                    children: [
                      _jsxs("span", {
                        children: [
                          "ðŸŽ¨ ì„ íƒëœ ìŠ¤íƒ€ì¼: ",
                          _jsx("strong", { children: styleDescription })
                        ]
                      }),
                      _jsx("button", {
                        onClick: () => { setCustomStyle(''); setStyleDescription(''); },
                        className: "text-red-400 hover:text-red-300",
                        children: "âœ• í•´ì œ"
                      })
                    ]
                  }),
                  _jsx("div", {
                    className: "max-h-64 overflow-y-auto bg-gray-800 rounded-lg p-3",
                    children: VISUAL_STYLES.map((category, catIdx) => _jsxs("div", {
                      className: "mb-4",
                      children: [
                        _jsx("h4", { className: "text-sm font-medium text-gray-400 mb-2", children: category.category }),
                        _jsx("div", {
                          className: "flex flex-wrap gap-2",
                          children: category.items.map((item, itemIdx) => _jsx("button", {
                            onClick: () => handleStyleSelect(item),
                            className: `px-3 py-1.5 text-sm rounded-full border ${customStyle === item.prompt ? 'bg-blue-600 border-blue-500' : 'bg-gray-700 border-gray-600 hover:bg-gray-600'}`,
                            title: item.desc,
                            children: item.label
                          }, itemIdx))
                        })
                      ]
                    }, catIdx))
                  })
                ]
              }),
              
              // Settings Row
              _jsxs("div", {
                className: "grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",
                children: [
                  // Aspect Ratio
                  _jsxs("div", {
                    children: [
                      _jsx("label", { className: "block text-sm text-gray-400 mb-1", children: "í™”ë©´ ë¹„ìœ¨" }),
                      _jsx("select", {
                        value: aspectRatio,
                        onChange: (e) => setAspectRatio(e.target.value),
                        className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                        children: RATIOS.map(r => _jsx("option", { value: r.id, children: r.label }, r.id))
                      })
                    ]
                  }),
                  
                  // Video Format
                  _jsxs("div", {
                    children: [
                      _jsx("label", { className: "block text-sm text-gray-400 mb-1", children: "ì˜ìƒ í¬ë§·" }),
                      _jsx("select", {
                        value: videoFormat,
                        onChange: (e) => setVideoFormat(e.target.value),
                        className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                        children: VIDEO_FORMATS.map(f => _jsx("option", { value: f.id, children: f.label }, f.id))
                      })
                    ]
                  }),
                  
                  // Image Model
                  _jsxs("div", {
                    children: [
                      _jsx("label", { className: "block text-sm text-gray-400 mb-1", children: "ì´ë¯¸ì§€ ëª¨ë¸" }),
                      _jsx("select", {
                        value: imageModel,
                        onChange: (e) => setImageModel(e.target.value),
                        className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                        children: IMAGE_MODELS.map(m => _jsx("option", { value: m.id, children: m.label }, m.id))
                      })
                    ]
                  }),
                  
                  // Video Model
                  _jsxs("div", {
                    children: [
                      _jsx("label", { className: "block text-sm text-gray-400 mb-1", children: "ë¹„ë””ì˜¤ ëª¨ë¸" }),
                      _jsx("select", {
                        value: videoModel,
                        onChange: (e) => setVideoModel(e.target.value),
                        className: "w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white",
                        children: VIDEO_MODELS.map(m => _jsx("option", { value: m.id, children: m.label }, m.id))
                      })
                    ]
                  })
                ]
              }),
              
              // Character Appearance
              _jsxs("div", {
                className: "mb-6",
                children: [
                  _jsx("label", { className: "block text-sm text-gray-400 mb-2", children: "ðŸ‘¤ ìºë¦­í„° ì¶œì—° ë¹ˆë„" }),
                  _jsx("div", {
                    className: "flex gap-3",
                    children: [
                      { id: CharacterAppearance.AUTO, label: "ðŸ¤– ìžë™", desc: "ëŒ€ì‚¬/í–‰ë™ì´ ì¤‘ìš”í•  ë•Œë§Œ" },
                      { id: CharacterAppearance.ALWAYS, label: "ðŸ‘¤ í•­ìƒ", desc: "ëª¨ë“  ìž¥ë©´ì— ë“±ìž¥" },
                      { id: CharacterAppearance.MINIMAL, label: "ðŸžï¸ ìµœì†Œí™”", desc: "í’ê²½/ìžë£Œí™”ë©´ ìœ„ì£¼" }
                    ].map(opt => _jsxs("button", {
                      onClick: () => setCharacterAppearance(opt.id),
                      className: `flex-1 px-4 py-3 rounded-lg border ${characterAppearance === opt.id ? 'bg-blue-600 border-blue-500' : 'bg-gray-800 border-gray-700 hover:bg-gray-700'}`,
                      children: [
                        _jsx("div", { className: "font-medium", children: opt.label }),
                        _jsx("div", { className: "text-xs text-gray-400 mt-1", children: opt.desc })
                      ]
                    }, opt.id))
                  })
                ]
              }),
              
              // Analyze Button
              _jsx("button", {
                onClick: handleAnalyzeScript,
                disabled: isLoading || !script.trim() || missingKeys.length > 0,
                className: "w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-xl hover:from-blue-500 hover:to-purple-500 disabled:opacity-50 disabled:cursor-not-allowed",
                children: isLoading ? "ðŸ”„ ë¶„ì„ ì¤‘..." : "âœ¨ ëŒ€ë³¸ ë¶„ì„ & ìŠ¤í† ë¦¬ë³´ë“œ ìƒì„±"
              })
            ]
          }),
          
          // Scenes Section
          scenes.length > 0 && _jsxs("section", {
            className: "bg-gray-900 rounded-xl p-6",
            children: [
              _jsxs("div", {
                className: "flex justify-between items-center mb-6",
                children: [
                  _jsx("h2", { className: "text-xl font-bold", children: `ðŸŽ¬ ìŠ¤í† ë¦¬ë³´ë“œ (${scenes.length}ì»·)` }),
                  _jsxs("div", {
                    className: "flex gap-3",
                    children: [
                      _jsx("button", {
                        onClick: handleGenerateAllImages,
                        disabled: isLoading,
                        className: "px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500 disabled:opacity-50",
                        children: "ðŸ–¼ï¸ ì „ì²´ ì´ë¯¸ì§€ ìƒì„±"
                      }),
                      _jsx("button", {
                        onClick: handleDownloadZip,
                        className: "px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600",
                        children: "ðŸ“¦ ZIP ë‹¤ìš´ë¡œë“œ"
                      })
                    ]
                  })
                ]
              }),
              
              _jsx("div", {
                className: "grid gap-6",
                children: scenes.map((scene, index) => _jsxs("div", {
                  className: "bg-gray-800 rounded-xl p-4 border border-gray-700",
                  children: [
                    // Scene Header
                    _jsxs("div", {
                      className: "flex justify-between items-start mb-4",
                      children: [
                        _jsxs("div", {
                          children: [
                            _jsx("span", { className: "text-sm text-gray-400", children: `ì”¬ ${index + 1}` }),
                            _jsx("span", {
                              className: `ml-2 px-2 py-0.5 text-xs rounded ${scene.sceneType === 'PRESENTER' ? 'bg-blue-600' : 'bg-purple-600'}`,
                              children: scene.sceneType
                            })
                          ]
                        }),
                        _jsx("span", { className: "text-sm text-gray-500", children: `~${scene.duration || 3}ì´ˆ` })
                      ]
                    }),
                    
                    // Scene Content
                    _jsxs("div", {
                      className: "grid md:grid-cols-2 gap-4",
                      children: [
                        // Script
                        _jsxs("div", {
                          children: [
                            _jsx("h4", { className: "text-sm font-medium text-gray-400 mb-2", children: "ðŸ“ ëŒ€ë³¸" }),
                            _jsx("p", { className: "text-white", children: scene.script })
                          ]
                        }),
                        
                        // Visual
                        _jsxs("div", {
                          children: [
                            _jsx("h4", { className: "text-sm font-medium text-gray-400 mb-2", children: "ðŸ–¼ï¸ ì´ë¯¸ì§€" }),
                            _jsxs("div", {
                              className: "relative aspect-video bg-gray-700 rounded-lg overflow-hidden",
                              children: [
                                scene.imageUrl ? 
                                  _jsx("img", { src: scene.imageUrl, alt: `Scene ${index + 1}`, className: "w-full h-full object-cover" }) :
                                  _jsxs("div", {
                                    className: "w-full h-full flex flex-col items-center justify-center text-gray-500",
                                    children: [
                                      scene.isGenerating ? 
                                        _jsx("span", { className: "animate-pulse", children: "ðŸŽ¨ ìƒì„± ì¤‘..." }) :
                                        _jsx("span", { children: "ì´ë¯¸ì§€ ì—†ìŒ" })
                                    ]
                                  }),
                                
                                !scene.imageUrl && !scene.isGenerating && _jsx("button", {
                                  onClick: () => handleGenerateImage(scene.id),
                                  className: "absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 hover:opacity-100 transition-opacity",
                                  children: _jsx("span", { className: "px-4 py-2 bg-blue-600 rounded-lg", children: "ðŸŽ¨ ì´ë¯¸ì§€ ìƒì„±" })
                                })
                              ]
                            })
                          ]
                        })
                      ]
                    }),
                    
                    // Video Section
                    scene.imageUrl && _jsxs("div", {
                      className: "mt-4 pt-4 border-t border-gray-700",
                      children: [
                        _jsx("h4", { className: "text-sm font-medium text-gray-400 mb-2", children: "ðŸŽ¬ ë¹„ë””ì˜¤" }),
                        scene.videoUrl ? 
                          _jsx("video", {
                            src: scene.videoUrl,
                            controls: true,
                            className: "w-full rounded-lg"
                          }) :
                          _jsx("div", {
                            className: "flex gap-2",
                            children: [
                              _jsx("button", {
                                onClick: () => handleGenerateVideo(scene.id, VideoModel.GROK),
                                disabled: scene.isGeneratingVideo,
                                className: "px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-500 disabled:opacity-50",
                                children: scene.isGeneratingVideo ? "ìƒì„± ì¤‘..." : "ðŸŽ¬ Grok ë¹„ë””ì˜¤"
                              }),
                              _jsx("button", {
                                onClick: () => handleGenerateVideo(scene.id, VideoModel.VEO_FAST),
                                disabled: scene.isGeneratingVideo,
                                className: "px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500 disabled:opacity-50",
                                children: "ðŸŽ¬ Veo Fast"
                              }),
                              _jsx("button", {
                                onClick: () => handleGenerateVideo(scene.id, VideoModel.VEO_QUALITY),
                                disabled: scene.isGeneratingVideo,
                                className: "px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-500 disabled:opacity-50",
                                children: "ðŸŽ¬ Veo HQ"
                              })
                            ]
                          })
                      ]
                    }),
                    
                    // Visual Prompt (collapsible)
                    _jsxs("details", {
                      className: "mt-4",
                      children: [
                        _jsx("summary", { className: "text-sm text-gray-400 cursor-pointer hover:text-gray-300", children: "ðŸ“‹ ë¹„ì£¼ì–¼ í”„ë¡¬í”„íŠ¸ ë³´ê¸°" }),
                        _jsx("p", { className: "mt-2 text-sm text-gray-500 bg-gray-700/50 p-3 rounded-lg", children: scene.visualPrompt })
                      ]
                    })
                  ]
                }, scene.id))
              })
            ]
          })
        ]
      }),
      
      // Footer
      _jsx("footer", {
        className: "text-center text-gray-500 text-sm py-8",
        children: "ðŸŽ¬ ì˜¬ì¸ì› í”„ë¡œë•ì…˜ | Powered by Gemini, Grok & Veo"
      })
    ]
  });
};

// ===================== RENDER =====================
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(_jsx(React.StrictMode, { children: _jsx(App, {}) }));
</script>
